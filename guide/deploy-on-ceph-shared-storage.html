<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.33">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="./favicon.ico"><title>Deploy on Ceph Shared Storage | PolarDB for PostgreSQL</title><meta name="description" content="A cloud-native database service independently developed by Alibaba Cloud">
    <link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/app.f0f32e1b.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/deploy-on-ceph-shared-storage.html.1726a942.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/deploy-on-ceph-shared-storage.html.65babf30.js">
    <link rel="stylesheet" href="/PolarDB-for-PostgreSQL/assets/style.7dad8b5e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/PolarDB-for-PostgreSQL/" class=""><img class="logo" src="/PolarDB-for-PostgreSQL/images/polardb.png" alt="PolarDB for PostgreSQL"><span class="site-name can-hide">PolarDB for PostgreSQL</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/guide/" class="router-link-active" aria-label="Getting Started"><!--[--><!--]--> Getting Started <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Architecture"><span class="title">Architecture</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Architecture"><span class="title">Architecture</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/README.md" class="" aria-label="Overview"><!--[--><!--]--> Overview <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/buffer-management.md" class="" aria-label="Buffer Management"><!--[--><!--]--> Buffer Management <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/ddl-synchronization.md" class="" aria-label="DDL Synchronization"><!--[--><!--]--> DDL Synchronization <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/logindex.md" class="" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/roadmap/" class="" aria-label="Roadmap"><!--[--><!--]--> Roadmap <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Community"><span class="title">Community</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Community"><span class="title">Community</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/contributing-polardb-kernel.md" class="" aria-label="Code Contributing"><!--[--><!--]--> Code Contributing <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/contributing-polardb-docs.md" class="" aria-label="Docs Contributing"><!--[--><!--]--> Docs Contributing <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/coding-style.md" class="" aria-label="Coding Style"><!--[--><!--]--> Coding Style <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/code-of-conduct.md" class="" aria-label="Code of Conduct"><!--[--><!--]--> Code of Conduct <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-on-ceph-shared-storage.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/guide/" class="router-link-active" aria-label="Getting Started"><!--[--><!--]--> Getting Started <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Architecture"><span class="title">Architecture</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Architecture"><span class="title">Architecture</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/README.md" class="" aria-label="Overview"><!--[--><!--]--> Overview <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/buffer-management.md" class="" aria-label="Buffer Management"><!--[--><!--]--> Buffer Management <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/ddl-synchronization.md" class="" aria-label="DDL Synchronization"><!--[--><!--]--> DDL Synchronization <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/logindex.md" class="" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/roadmap/" class="" aria-label="Roadmap"><!--[--><!--]--> Roadmap <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Community"><span class="title">Community</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Community"><span class="title">Community</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/contributing-polardb-kernel.md" class="" aria-label="Code Contributing"><!--[--><!--]--> Code Contributing <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/contributing-polardb-docs.md" class="" aria-label="Docs Contributing"><!--[--><!--]--> Docs Contributing <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/coding-style.md" class="" aria-label="Coding Style"><!--[--><!--]--> Coding Style <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/contributing/code-of-conduct.md" class="" aria-label="Code of Conduct"><!--[--><!--]--> Code of Conduct <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-on-ceph-shared-storage.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p class="sidebar-item sidebar-heading active">Getting Started <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/guide/" class="router-link-active sidebar-item" aria-label="Introduction"><!--[--><!--]--> Introduction <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/guide/deploy-on-cloud.html" class="sidebar-item" aria-label="Deploy on Alibaba Cloud Service"><!--[--><!--]--> Deploy on Alibaba Cloud Service <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/guide/deploy-on-local-storage.html" class="sidebar-item" aria-label="Deploy on Local Storage"><!--[--><!--]--> Deploy on Local Storage <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/guide/deploy-on-nbd-shared-storage.html" class="sidebar-item" aria-label="Deploy on NBD Shared Storage"><!--[--><!--]--> Deploy on NBD Shared Storage <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Deploy on Ceph Shared Storage"><!--[--><!--]--> Deploy on Ceph Shared Storage <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#环境准备" class="router-link-active router-link-exact-active sidebar-item" aria-label="环境准备"><!--[--><!--]--> 环境准备 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#mon-部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="mon 部署"><!--[--><!--]--> mon 部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#osd-部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="osd 部署"><!--[--><!--]--> osd 部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#mgr、mds、rgw-部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="mgr、mds、rgw 部署"><!--[--><!--]--> mgr、mds、rgw 部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#rbd-块设备创建" class="router-link-active router-link-exact-active sidebar-item" aria-label="rbd 块设备创建"><!--[--><!--]--> rbd 块设备创建 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#polardb-filesystem-安装部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="PolarDB-FileSystem 安装部署"><!--[--><!--]--> PolarDB-FileSystem 安装部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/guide/deploy-on-ceph-shared-storage.html#polardb-for-postgresql-内核安装部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="PolarDB-for-PostgreSQL 内核安装部署"><!--[--><!--]--> PolarDB-for-PostgreSQL 内核安装部署 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/PolarDB-for-PostgreSQL/guide/deploy-on-polardb-stack.html" class="sidebar-item" aria-label="Deploy on PolarDB Stack"><!--[--><!--]--> Deploy on PolarDB Stack <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="deploy-on-ceph-shared-storage" tabindex="-1"><a class="header-anchor" href="#deploy-on-ceph-shared-storage" aria-hidden="true">#</a> Deploy on Ceph Shared Storage</h1><div class="custom-container danger"><p class="custom-container-title">DANGER</p><p>Translation needed.</p></div><p>Ceph 是一个统一的分布式存储系统，由于它可以提供较好的性能、可靠性和可扩展性，被广泛的应用在存储领域。以下是在 ceph 分布式集群上部署 PolarDB-FileSystem 以及 PolarDB-for-PostgreSQL 的教程。</p><p>ceph 搭建需要 2 台及以上的物理机/虚拟机实现存储共享与数据备份，本教程以 3 台虚拟机机环境为例，介绍基于 ceph 共享存储的实例构建方法。大体如下：</p><ol><li>获取在同一网段的虚拟机三台，互相之间配置 ssh 免密登录，用作 ceph 密钥与配置信息的同步；</li><li>在主节点启动 mon 进程，查看状态，并复制配置文件至其余各个节点，完成 mon 启动；</li><li>在三个环境中启动 osd 进程配置存储盘，并在主节点环境启动 mgr 进程、rgw 进程；</li><li>创建存储池与 rbd 块设备镜像，并对创建好的镜像在各个节点进行映射即可实现块设备的共享；</li><li>对块设备进行 PolarFS 的格式化与 PolarDB 的部署。</li></ol><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>操作系统版本要求 CentOS 7.5 及以上。以下步骤在 CentOS 7.5 上通过测试。</p></div><h2 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h2><pre><code>- 使用的虚拟机环境如下：

```
IP                  hostname
192.168.1.173       ceph001
192.168.1.174       ceph002
192.168.1.175       ceph003
```
- 安装docker
    &gt; 说明：本教程使用阿里云镜像站提供的docker包。
    - 安装docker依赖包:

        ```
        yum install -y yum-utils device-mapper-persistent-data lvm2
        ```
    - 安装并启动docker：

        ```
        yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
        yum makecache
        yum install -y docker-ce

        systemctl start docker
        systemctl enable docker
        ```
    - 检查是否安装成功：

        ```
        docker run hello-world
         ```
- 配置ssh免密登录
    - 密钥的生成与拷贝：

        ```
        ssh-keygen
        ssh-copy-id -i /root/.ssh/id_rsa.pub    root@ceph001
        ssh-copy-id -i /root/.ssh/id_rsa.pub    root@ceph002
        ssh-copy-id -i /root/.ssh/id_rsa.pub    root@ceph003
        ```
    - 检查是否配置成功

        ```
        ssh root@ceph003
        ```
- 下载ceph daemon

    ```bash
    docker pull ceph/daemon
    ```
</code></pre><h2 id="mon-部署" tabindex="-1"><a class="header-anchor" href="#mon-部署" aria-hidden="true">#</a> mon 部署</h2><pre><code>- ceph001上mon进程启动

    ```
    docker run -d \
               --net=host \
               --privileged=true \
               -v /etc/ceph:/etc/ceph \
               -v /var/lib/ceph/:/var/lib/ceph/ \
               -e MON_IP=192.168.1.173  \
               -e CEPH_PUBLIC_NETWORK=192.168.1.0/24 \
               --security-opt seccomp=unconfined \
               --name=mon01 \
               ceph/daemon mon
    ```
    **注意：根据实际网络环境修改IP、子网掩码位数。**
- 查看容器状态

    ```
    docker exec mon01 ceph -s
    cluster:
      id:     937ccded-3483-4245-9f61-e6ef0dbd85ca
      health: HEALTH_OK

    services:
      mon: 1 daemons, quorum ceph001 (age 26m)
      mgr: no daemons active
      osd: 0 osds: 0 up, 0 in

    data:
      pools:   0 pools, 0 pgs
      objects: 0 objects, 0 B
      usage:   0 B used, 0 B / 0 B avail
      pgs:
    ```
    **注意：如果遇到mon is allowing insecure global_id reclaim的报错，使用以下命令解决。**

    ```
    docker exec mon01 ceph config set mon   auth_allow_insecure_global_id_reclaim false
    ```
- 生成必须的keyring

    ```
    docker exec mon01  ceph auth get client.    bootstrap-osd -o /var/lib/ceph/bootstrap-osd/   ceph.keyring
    docker exec mon01 ceph auth get client. bootstrap-rgw -o /var/lib/ceph/bootstrap-rgw/    ceph.keyring
    ```
- 配置文件同步

    ```
    ssh root@ceph002 mkdir -p /var/lib/ceph
    scp -r /etc/ceph root@ceph002:/etc
    scp -r /var/lib/ceph/bootstrap* root@ceph002:/  var/lib/ceph
    ssh root@ceph003 mkdir -p /var/lib/ceph
    scp -r /etc/ceph root@ceph003:/etc
    scp -r /var/lib/ceph/bootstrap* root@ceph003:/  var/lib/ceph
    ```
- 在ceph002与ceph003中启动mon

    ```bash
     docker run -d \
        --net=host \
        --privileged=true \
        -v /etc/ceph:/etc/ceph \
        -v /var/lib/ceph/:/var/lib/ceph/ \
        -e MON_IP=192.168.1.174  \
        -e CEPH_PUBLIC_NETWORK=192.168.1.0/24 \
        --security-opt seccomp=unconfined \
        --name=mon02 \
        ceph/daemon mon

     docker run -d \
        --net=host \
        --privileged=true \
        -v /etc/ceph:/etc/ceph \
        -v /var/lib/ceph/:/var/lib/ceph/ \
        -e MON_IP=1192.168.1.175  \
        -e CEPH_PUBLIC_NETWORK=192.168.1.0/24 \
        --security-opt seccomp=unconfined \
        --name=mon03 \
        ceph/daemon mon
    ```
- 查看当前集群状态

    ```
    docker exec mon01 ceph -s
    cluster:
      id:     937ccded-3483-4245-9f61-e6ef0dbd85ca
      health: HEALTH_OK

    services:
      mon: 3 daemons, quorum ceph001,ceph002,   ceph003 (age 35s)
      mgr: no daemons active
      osd: 0 osds: 0 up, 0 in

    data:
      pools:   0 pools, 0 pgs
      objects: 0 objects, 0 B
      usage:   0 B used, 0 B / 0 B avail
      pgs:
    ```
    **注意：从mon节点信息查看是否有添加在另外两个节点创建的mon添加进来。**
</code></pre><h2 id="osd-部署" tabindex="-1"><a class="header-anchor" href="#osd-部署" aria-hidden="true">#</a> osd 部署</h2><pre><code>- osd准备阶段：
    &gt;本环境的虚拟机只有一个/dev/vdb磁盘可用，因此为每个虚拟机只创建了一个osd节点。

    ```
    docker run --rm --privileged=true --net=host -  -ipc=host \
                    --security-opt seccomp=unconfined \
                    -v /run/lock/lvm:/run/lock/lvm:z \
                    -v /var/run/udev/:/var/run/udev/:z \
                    -v /dev:/dev -v /etc/ceph:/etc/ceph:z \
                    -v /run/lvm/:/run/lvm/ \
                    -v /var/lib/ceph/:/var/lib/ceph/:z \
                    -v /var/log/ceph/:/var/log/ceph/:z \
                    --entrypoint=ceph-volume \
                    docker.io/ceph/daemon \
                    --cluster ceph lvm prepare --bluestore --data /dev/vdb
    ```
    **注意：以上命令在三个节点都是一样的，只需要根据磁盘名称进行修改调整即可。**
- osd激活阶段：

    ```
    docker run -d --privileged=true --net=host  --pid=host --ipc=host \
    				--security-opt  seccomp=unconfined \
                    -v /dev:/dev \
                    -v /etc/localtime:/etc/ localtime:ro \
                    -v /var/lib/ceph:/var/lib/  ceph:z \
                    -v /etc/ceph:/etc/ceph:z \
                    -v /var/run/ceph:/var/run/  ceph:z \
                    -v /var/run/udev/:/var/run/ udev/ \
                    -v /var/log/ceph:/var/log/  ceph:z \
                    -v /run/lvm/:/run/lvm/ \
                    -e CLUSTER=ceph \
                    -e  CEPH_DAEMON=OSD_CEPH_VOLUME_ACT  IVATE \
                    -e CONTAINER_IMAGE=docker.io/   ceph/daemon \
                    -e OSD_ID=0 \
                    --name=ceph-osd-0 \
                    docker.io/ceph/daemon
    ```
    **注意：各个节点需要修改OSD_ID与name属性，OSD_ID是从编号0递增的，其余节点为OSD_ID=1、OSD_ID=2。**
- 查看集群状态

    ```
    docker exec mon01 ceph -s
    cluster:
      id:     e430d054-dda8-43f1-9cda-c0881b782e17
      health: HEALTH_WARN
              no active mgr

    services:
      mon: 3 daemons, quorum ceph001,ceph002,   ceph003 (age 44m)
      mgr: no daemons active
      osd: 3 osds: 3 up (since 7m), 3 in (since     13m)

    data:
      pools:   0 pools, 0 pgs
      objects: 0 objects, 0 B
      usage:   0 B used, 0 B / 0 B avail
      pgs:
    ```
</code></pre><h2 id="mgr、mds、rgw-部署" tabindex="-1"><a class="header-anchor" href="#mgr、mds、rgw-部署" aria-hidden="true">#</a> mgr、mds、rgw 部署</h2><pre><code>- 以下命令均在ceph001进行：

    ```
    docker run -d --net=host \
                  --privileged=true \
                  --security-opt seccomp=unconfined \
                  -v /etc/ceph:/etc/ceph \
                  -v /var/lib/ceph/:/var/lib/ceph/ \
                  --name=ceph-mgr-0 \
                  ceph/daemon mgr

    docker run -d --net=host \
                  --privileged=true \
                  --security-opt seccomp=unconfined \
                  -v /var/lib/ceph/:/var/lib/ceph/ \
                  -v /etc/ceph:/etc/ceph \
                  -e CEPHFS_CREATE=1 \
                  --name=ceph-mds-0 \
                  ceph/daemon mds

    docker run -d --net=host \
                  --privileged=true \
                  --security-opt seccomp=unconfined \
                  -v /var/lib/ceph/:/var/lib/ceph/ \
                  -v /etc/ceph:/etc/ceph \
                  --name=ceph-rgw-0 \
                  ceph/daemon rgw
    ```
- 查看集群状态

    ```
    docker exec mon01 ceph -s
    cluster:
      id:     e430d054-dda8-43f1-9cda-c0881b782e17
      health: HEALTH_OK

    services:
      mon: 3 daemons, quorum ceph001,ceph002,   ceph003 (age 92m)
      mgr: ceph001(active, since 25m)
      mds: 1/1 daemons up
      osd: 3 osds: 3 up (since 54m), 3 in (since    60m)
      rgw: 1 daemon active (1 hosts, 1 zones)

    data:
      volumes: 1/1 healthy
      pools:   7 pools, 145 pgs
      objects: 243 objects, 7.2 KiB
      usage:   50 MiB used, 2.9 TiB / 2.9 TiB avail
      pgs:     145 active+clean
    ```
</code></pre><h2 id="rbd-块设备创建" tabindex="-1"><a class="header-anchor" href="#rbd-块设备创建" aria-hidden="true">#</a> rbd 块设备创建</h2><pre><code>&gt;以下命令均在容器mon01中进行。
- 存储池的创建：

    ```
       docker exec -it mon01 bash
       ceph osd pool create rbd_polar
    ```
- 创建镜像文件并查看信息

    ```
    rbd create --size 512000 rbd_polar/image02
    rbd info rbd_polar/image02

    rbd image &#39;image02&#39;:
    size 500 GiB in 128000 objects
    order 22 (4 MiB objects)
    snapshot_count: 0
    id: 13b97b252c5d
    block_name_prefix: rbd_data.13b97b252c5d
    format: 2
    features: layering, exclusive-lock,     object-map, fast-diff, deep-flatten
    op_features:
    flags:
    create_timestamp: Thu Oct 28 06:18:07 2021
    access_timestamp: Thu Oct 28 06:18:07 2021
    modify_timestamp: Thu Oct 28 06:18:07 2021
    ```
- 映射镜像文件

    ```
    rbd map rbd_polar/image02

    rbd: sysfs write failed
    RBD image feature set mismatch. You can     disable features unsupported by the kernel  with &quot;rbd feature    disable rbd_polar/image02   object-map fast-diff deep-flatten&quot;.
    In some cases useful info is found in syslog -  try &quot;dmesg | tail&quot;.
    rbd: map failed: (6) No such device or address
    ```
    **注意：某些特性内核不支持，需要关闭才可以映射成功。如下进行：关闭rbd不支持特性，重新映射镜像，并查看映射列表。**

    ```
    rbd feature disable rbd_polar/image02   object-map fast-diff deep-flatten
    rbd map rbd_polar/image02
    rbd device list

    id  pool       namespace  image    snap  device
    0   rbd_polar             image01  -     /dev/  rbd0
    1   rbd_polar             image02  -     /dev/  rbd1
    ```
    &gt;此处我已经先映射了一个image01，所以有两条信息。
- 查看块设备
    &gt;回到容器外，进行操作。查看系统中的块设备：

    ```
    lsblk

    NAME                                                               MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
    vda                                                                253:0    0  500G  0 disk
    └─vda1                                                             253:1    0  500G  0 part /
    vdb                                                                253:16   0 1000G  0 disk
    └─ceph--7eefe77f--c618--4477--a1ed--b4f44520dfc 2-osd--block--bced3ff1--42b9--43e1--8f63--e853b  ce41435
                                                                       252:0    0 1000G  0 lvm
    rbd0                                                               251:0    0  100G  0 disk
    rbd1                                                               251:16   0  500G  0 disk
    ```
    **注意：块设备镜像需要在各个节点都进行映射才可以在本地环境中通过lsblk命令查看到，否则不显示。ceph002与ceph003上映射命令与上述一致。**
</code></pre><h2 id="polardb-filesystem-安装部署" tabindex="-1"><a class="header-anchor" href="#polardb-filesystem-安装部署" aria-hidden="true">#</a> PolarDB-FileSystem 安装部署</h2><pre><code>&gt;请参考 方式3：搭建基于NBD共享存储 — PolarDB-FileSystem安装部署
</code></pre><h2 id="polardb-for-postgresql-内核安装部署" tabindex="-1"><a class="header-anchor" href="#polardb-for-postgresql-内核安装部署" aria-hidden="true">#</a> PolarDB-for-PostgreSQL 内核安装部署</h2><pre><code>&gt;请参考 方式3：搭建基于NBD共享存储 — PolarDB-for-PostgreSQL内核安装部署
</code></pre><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/edit/main/guide/deploy-on-ceph-shared-storage.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--> Edit this page on GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zunbao.fengzb@alibaba-inc.com">北侠</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/PolarDB-for-PostgreSQL/guide/deploy-on-nbd-shared-storage.html" class="" aria-label="Deploy on NBD Shared Storage"><!--[--><!--]--> Deploy on NBD Shared Storage <!--[--><!--]--></a></span><span class="next"><a href="/PolarDB-for-PostgreSQL/guide/deploy-on-polardb-stack.html" class="" aria-label="Deploy on PolarDB Stack"><!--[--><!--]--> Deploy on PolarDB Stack <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/PolarDB-for-PostgreSQL/assets/app.f0f32e1b.js" defer></script>
  </body>
</html>
